# Prompt 机制详解

## 🤔 你的两个问题

### 问题 1: Prompt 只能有10个反馈？超过10个会忘记之前的吗？

**答案：是的，目前只使用最近10个反馈**

**代码**（`api_classifier.py` 第 298 行）：
```python
user_feedback_examples[-10:]  # 只使用最近10个反馈
```

**这意味着**：
- ✅ 如果你有 50 个反馈，只使用**最近 10 个**
- ❌ **旧的反馈会被忽略**（不会出现在 prompt 中）
- ⚠️ 这不是"忘记"，而是**根本不使用**

**示例**：
- 反馈 1-40：被忽略
- 反馈 41-50：会被使用（最近10个）

### 问题 2: 每次调用API都要重新过一次prompt吗？

**答案：是的，每次API调用都包含完整的prompt**

**工作机制**：
1. **每次分类**都是一次独立的API调用
2. **每次调用**都包含完整的prompt：
   - 类别说明
   - 分类规则
   - 原始示例（75个）
   - **用户反馈示例（最近10个）**
   - 要分类的文章
3. **AI没有"记忆"**：每次都是全新的请求

**这意味着**：
- ✅ 每次分类都会看到最新的10个反馈
- ✅ 如果反馈更新，下次分类立即生效
- ❌ AI不会"记住"之前的分类结果
- ❌ 每次都是独立的，不积累经验

## 📊 详细解释

### Prompt 的完整结构

每次API调用时，prompt包含：

```
1. 系统角色定义
   "You are a professional news classification assistant..."

2. 类别说明（22个类别）
   - Administration: ...
   - Trade & Commerce: ...
   ...

3. 分类规则
   - National-Level vs Company-Level
   - 分类规则1-7

4. 原始示例（75个）
   - "Trump orders tariff pause..." → Administration
   - "China biotech faces..." → Biotech
   ...

5. 用户反馈示例（最近10个）
   - "China rolls out red carpet..." → US Multilateralism
   - "Tencent AI launches..." → Uncategorized
   ...

6. 要分类的文章
   Article to classify:
   {headline + summary}
```

### 为什么只使用10个反馈？

**原因**：
1. **Token 限制**：OpenAI API 有 token 限制（通常 128K tokens）
2. **成本考虑**：prompt 越长，成本越高
3. **效果考虑**：太多示例可能反而降低效果（信息过载）

**当前情况**：
- 75个原始示例 + 10个反馈 = 85个示例
- 如果增加到30个反馈 = 105个示例
- Prompt 会变得更长，成本更高

### 如何解决"只使用10个"的问题？

**方案 1: 增加反馈数量（简单）**

```python
# 当前
user_feedback_examples[-10:]  # 只使用最近10个

# 改进
user_feedback_examples[-30:]  # 使用最近30个
```

**优点**：
- ✅ 实现简单
- ✅ 可以使用更多反馈

**缺点**：
- ⚠️ Prompt 更长，成本更高
- ⚠️ 可能超过 token 限制

**方案 2: 智能选择反馈（推荐）**

不是简单的"最近10个"，而是：
- 选择与当前文章最相关的反馈（基于相似度）
- 选择不同类别的反馈（确保覆盖所有类别）
- 选择最近的、最准确的反馈

**优点**：
- ✅ 不受"10个"限制
- ✅ 更精准，更相关
- ✅ 可以处理更多反馈

**缺点**：
- ⚠️ 需要开发（计算相似度）

**方案 3: 分类规则提取（高级）**

从反馈中提取规则，而不是直接使用示例：
- 分析反馈，提取分类规则
- 将规则添加到prompt中
- 规则比示例更简洁

**示例**：
```
从反馈中提取规则：
- "中国接待外国领导人" → US Multilateralism
- "公司产品发布" → Uncategorized

转换为规则：
- 中国接待外国领导人的新闻应归类到 US Multilateralism
- 公司产品发布应归类到 Uncategorized
```

## 💡 实际建议

### 短期改进

1. **增加反馈数量**：从10个增加到20-30个
   - 简单，但成本会增加

2. **添加"原因"字段**：让反馈更有价值
   - 即使只有10个，质量更高

### 中期改进

1. **智能选择反馈**：基于相似度选择最相关的反馈
   - 不受数量限制
   - 更精准

2. **规则提取**：从反馈中提取规则
   - 更简洁
   - 可以处理更多反馈

## 📝 总结

**问题 1: 只能有10个反馈？**
- ✅ 是的，目前只使用最近10个
- ✅ 超过10个，旧的会被忽略
- ✅ 可以改进为智能选择或增加数量

**问题 2: 每次都要重新过prompt？**
- ✅ 是的，每次API调用都包含完整的prompt
- ✅ AI没有"记忆"，每次都是独立的
- ✅ 这是正常的，因为使用的是预训练模型，不是fine-tuned模型

