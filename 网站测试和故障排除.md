# 网站测试和故障排除指南

## 🧪 测试步骤

### 步骤 1: 确认主文件

**重要**：Streamlit Cloud 必须使用 `app_with_sheets_db.py` 作为主文件！

1. **打开 Streamlit Cloud**: https://share.streamlit.io
2. **找到你的应用** → **Settings**
3. **检查 "Main file"** 是否为: `app_with_sheets_db.py`
4. **如果不是**，改成 `app_with_sheets_db.py` 并保存

---

### 步骤 2: 测试网站读取 Google Sheets

1. **打开你的网站**
2. **设置日期范围**：
   - Start date: `2025-11-03`（或包含今天）
   - End date: `2025-11-03`（或今天）
3. **勾选**: "从 Google Sheets 读取历史数据（NYT, SCMP, Reuters）"
4. **输入 Spreadsheet ID**: `1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA`
5. **选择所有来源**（或至少选择 NYT, SCMP, Reuters）
6. **点击**: "Generate & Export"

---

### 步骤 3: 检查输出信息

**应该看到**：
- ✅ "✅ 从 Google Sheets 读取了 X 条历史数据"
- ✅ "✅ 合并完成: Google Sheets (X 条) + RSS (X 条) = 总计 X 条（去重后）"
- ✅ Excel 文件可以下载

**如果看到**：
- ⚠️ "⚠️ 无法读取 Google Sheets: ..." → 见下方故障排除

---

## 🐛 常见问题和解决方案

### 问题 1: "无法读取 Google Sheets"

**可能原因**：
1. Streamlit Secrets 未配置
2. Google Sheets 未分享给 Service Account
3. Spreadsheet ID 错误

**解决方案**：

1. **检查 Streamlit Secrets**：
   - Streamlit Cloud → Settings → Secrets
   - 确认有 `GOOGLE_SHEETS_ID` 和 `[google_sheets].credentials`

2. **检查 Google Sheets 分享**：
   - 打开 Google Sheets
   - 确认已分享给: `us-china-scraper@us-china-news-scraper.iam.gserviceaccount.com`
   - 权限为 "Editor"

3. **检查 Spreadsheet ID**：
   - 从 URL 中提取: `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`
   - 应该是: `1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA`

---

### 问题 2: "从 Google Sheets 读取了 0 条历史数据"

**可能原因**：
1. 日期范围不匹配
2. Google Sheets 中没有对应日期的数据
3. Sheet 名称不对

**解决方案**：

1. **检查日期范围**：
   - Google Sheets 中的数据日期是: `2025-11-03`
   - 网站选择的日期范围应该**包含**这个日期

2. **检查 Google Sheets 数据**：
   - 打开: https://docs.google.com/spreadsheets/d/1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA/edit
   - 确认 Sheet `Week 2025-11-03` 中有数据
   - 确认 "Date" 列的格式正确

3. **尝试扩大日期范围**：
   - Start date: `2025-11-01`
   - End date: `2025-11-05`

---

### 问题 3: Excel 文件为空或只有标题

**可能原因**：
1. 数据合并失败
2. 所有数据都被过滤掉了
3. 日期范围不匹配

**解决方案**：

1. **检查网站输出的信息**：
   - 应该显示 "合并完成: Google Sheets (X 条) + RSS (X 条) = 总计 X 条"
   - 如果显示 "未找到文章"，说明日期范围或数据有问题

2. **尝试只使用 RSS 数据**：
   - **取消勾选** "从 Google Sheets 读取历史数据"
   - 选择日期范围（今天或最近几天）
   - 点击 "Generate & Export"
   - 如果 RSS 数据正常，说明问题在 Google Sheets 读取

3. **检查日期格式**：
   - Google Sheets 中的 "Date" 列应该是标准日期格式
   - 例如: `2025-11-03` 或 `2025-11-03 22:00:00`

---

### 问题 4: 只看到 RSS 数据，没有 Google Sheets 数据

**可能原因**：
1. Google Sheets 读取失败但被忽略了
2. 数据去重导致 Google Sheets 数据被删除

**解决方案**：

1. **检查网站输出的警告信息**：
   - 如果有 "⚠️ 无法读取 Google Sheets" 警告，说明读取失败
   - 按照问题 1 的解决方案修复

2. **检查数据去重**：
   - 如果 Google Sheets 和 RSS 有相同的 URL，去重会保留第一个
   - 这是正常的，因为同一篇文章不应该重复

---

## ✅ 正确的测试流程

### 测试 1: 只测试 Google Sheets（推荐先做这个）

1. **设置日期**: `2025-11-03` 到 `2025-11-03`
2. **勾选**: "从 Google Sheets 读取历史数据"
3. **只选择**: NYT, SCMP, Reuters
4. **点击**: "Generate & Export"
5. **应该看到**: 48 篇文章（或更多）

### 测试 2: 测试合并（Google Sheets + RSS）

1. **设置日期**: `2025-11-03` 到 `今天`
2. **勾选**: "从 Google Sheets 读取历史数据"
3. **选择所有来源**
4. **点击**: "Generate & Export"
5. **应该看到**: Google Sheets 数据 + RSS 实时数据

### 测试 3: 只测试 RSS（验证 RSS 功能）

1. **取消勾选**: "从 Google Sheets 读取历史数据"
2. **设置日期**: `今天` 到 `今天`
3. **选择所有来源**
4. **点击**: "Generate & Export"
5. **应该看到**: 实时 RSS 数据

---

## 📋 检查清单

测试前检查：

- [ ] Streamlit Cloud 主文件是 `app_with_sheets_db.py`
- [ ] Streamlit Secrets 已正确配置
- [ ] Google Sheets 已分享给 Service Account
- [ ] Google Sheets 中有数据（Sheet: `Week 2025-11-03`）
- [ ] 日期范围包含 Google Sheets 中的日期

测试后检查：

- [ ] 网站显示 "✅ 从 Google Sheets 读取了 X 条历史数据"
- [ ] 网站显示合并后的总数
- [ ] Excel 文件可以下载
- [ ] Excel 文件中有文章数据

---

## 🆘 如果还是不行

请提供以下信息：

1. **网站显示的警告/错误信息**（截图或文字）
2. **选择的日期范围**
3. **是否勾选了 "从 Google Sheets 读取历史数据"**
4. **网站显示的数据统计**（例如：合并完成: X 条）

这样我可以更准确地帮你解决问题。

