# Classification Feedback 机制说明

## 🔍 当前实现

### 反馈数量限制
- **当前设置**：使用最近 **20 个** "incorrect" 反馈（从 10 个增加到 20 个）
- **代码位置**：`api_classifier.py` 第 298 行
- **实现方式**：`user_feedback_examples[-20:]` （只取最后 20 个）

### 工作原理

1. **用户提供反馈**：
   - 在 Streamlit UI 中选择文章
   - 标记为 "Incorrect"
   - 选择正确的类别
   - （可选）填写原因

2. **保存反馈**：
   - 反馈保存到 `classification_feedback.json`
   - 格式：
     ```json
     {
       "url": {
         "status": "incorrect",
         "headline": "...",
         "correct_category": "...",
         "reason": "...",
         "timestamp": "..."
       }
     }
     ```

3. **使用反馈**：
   - 每次 API 分类时，读取 `classification_feedback.json`
   - 只使用 "incorrect" 状态的反馈
   - 只取最近 20 个反馈
   - 添加到 prompt 中作为 "few-shot learning" 示例

## ❓ 如果一直反馈会有什么效果？

### 当前机制的限制

1. **只保留最近 20 个**：
   - 如果反馈超过 20 个，**旧的反馈会被忽略**
   - 例如：如果反馈了 50 个，只有最后 20 个会被使用
   - **前面的 30 个反馈不会影响 AI 的分类**

2. **每次 API 调用都重新读取**：
   - 每次分类时，都会重新读取 `classification_feedback.json`
   - 所以最新的 20 个反馈会一直生效
   - 但如果反馈超过 20 个，旧的反馈就"丢失"了

### 实际效果

**场景 1：反馈少于 20 个**
- ✅ 所有反馈都会被使用
- ✅ AI 会学习所有反馈

**场景 2：反馈超过 20 个**
- ⚠️ 只有最近 20 个反馈会被使用
- ⚠️ 旧的反馈会被"遗忘"
- ⚠️ 如果早期反馈了重要的错误模式，可能会被忽略

**场景 3：持续反馈**
- ✅ 最新的反馈会一直生效
- ⚠️ 但旧的反馈会被"遗忘"
- ⚠️ 如果错误模式重复出现，需要重新反馈

## 💡 改进建议

### 方案 1：增加反馈数量（简单）

**优点**：
- 实现简单
- 可以保留更多反馈

**缺点**：
- Prompt 会变长，增加 token 成本
- 仍然有上限（例如 50 个、100 个）

**实现**：
```python
user_feedback_examples[-50:]  # 从 20 增加到 50
```

### 方案 2：智能选择反馈（推荐）

**思路**：
- 不只看时间，还要看反馈的"重要性"
- 例如：选择最常见的错误模式

**优点**：
- 保留最有价值的反馈
- 不浪费 token

**缺点**：
- 实现复杂
- 需要分析反馈模式

**实现思路**：
```python
# 1. 统计每个错误类别的反馈数量
# 2. 选择最常见的错误模式
# 3. 每个错误模式选择 2-3 个代表性反馈
# 4. 总共保留 20-30 个反馈
```

### 方案 3：反馈优先级（折中）

**思路**：
- 保留最近 10 个反馈（最新）
- 保留最常见的 10 个错误模式（重要）
- 总共 20 个

**优点**：
- 平衡新旧反馈
- 保留重要模式

**缺点**：
- 实现中等复杂

### 方案 4：Fine-tuning（长期）

**思路**：
- 收集足够反馈后（例如 500+ 个）
- 进行 Fine-tuning
- 让模型真正"学习"这些反馈

**优点**：
- 永久学习，不需要每次发送 prompt
- 更准确

**缺点**：
- 需要大量反馈（500+）
- 需要 Fine-tuning 成本
- 修改规则需要重新训练

## 🎯 当前建议

### 短期（现在）
1. **保持 20 个反馈**（当前设置）
2. **定期检查反馈文件**：
   - 如果反馈超过 20 个，考虑清理旧的反馈
   - 或者增加到 30-50 个

### 中期（1-2 个月后）
1. **如果反馈超过 50 个**：
   - 考虑实现"智能选择反馈"（方案 2）
   - 或者增加到 50 个（方案 1）

### 长期（3-6 个月后）
1. **如果反馈超过 500 个**：
   - 考虑 Fine-tuning（方案 4）
   - 让模型真正学习这些反馈

## 📊 如何查看当前反馈数量

```bash
# 查看反馈文件
cat classification_feedback.json | jq 'length'

# 查看 "incorrect" 反馈数量
cat classification_feedback.json | jq '[.[] | select(.status == "incorrect")] | length'
```

## 🔧 如何调整反馈数量

编辑 `api_classifier.py` 第 298 行：

```python
# 当前：20 个
user_feedback_examples[-20:]

# 改为：50 个
user_feedback_examples[-50:]

# 改为：30 个
user_feedback_examples[-30:]
```

## ⚠️ 注意事项

1. **Token 成本**：
   - 每个反馈大约 50-100 tokens
   - 20 个反馈 ≈ 1000-2000 tokens
   - 50 个反馈 ≈ 2500-5000 tokens
   - 会增加每次 API 调用的成本

2. **Prompt 长度限制**：
   - GPT-4o-mini 支持很长的 prompt
   - 但太长的 prompt 可能影响响应速度
   - 建议不超过 100 个反馈

3. **反馈质量**：
   - 不是反馈越多越好
   - 重要的是反馈的**代表性**和**准确性**
   - 如果反馈有错误，会影响 AI 的学习

