# 使用说明

## 功能概述

系统支持每天自动抓取 NYT (New York Times)、SCMP (South China Morning Post)、Reuters 三个来源当天的新闻并上传到 Google Sheets。生成 Excel 时会自动合并 Google Sheets 中的历史数据和 RSS 实时抓取的数据。

## 文件说明

- `daily_collector_to_sheets.py`: 每日抓取脚本，负责抓取当天的新闻并上传到 Google Sheets
- `app_with_sheets_db.py`: Streamlit 应用（支持从 Google Sheets 读取历史数据）
- `app.py`: Streamlit 应用（仅使用 RSS 实时抓取）
- `google_sheets_integration.py`: Google Sheets 集成功能

## 使用方法

### 方法 1: 手动运行定时任务（测试）

```bash
# 设置环境变量
export GOOGLE_SHEETS_ID="your-spreadsheet-id"
export GOOGLE_CREDENTIALS_PATH="google_credentials.json"

# 手动运行一次抓取
python daily_collector_to_sheets.py
```

### 方法 2: 使用系统 cron（推荐用于生产环境）

在 Linux/macOS 上，编辑 crontab：

```bash
crontab -e
```

添加以下行（每天凌晨 2 点运行）：

```
0 2 * * * cd /Users/tingyuzheng/Downloads/us_china_picker && GOOGLE_SHEETS_ID=your-spreadsheet-id python3 daily_collector_to_sheets.py >> daily_collect.log 2>&1
```

注意：请将路径和 Google Sheets ID 替换为实际值。

## Google Sheets 集成

### 数据来源说明

**Excel 下载的数据来源**：
- **Google Sheets**: NYT、SCMP、Reuters 三个优先来源的历史数据
- **RSS 实时抓取**: 所有其他来源的实时数据
- **自动合并去重**: 确保数据完整且不重复

### Google Sheets 中的内容

- **每周一个 sheet**: `Week 2025-11-03`、`Week 2025-11-10` 等
- **只包含 3 个优先来源**: NYT、SCMP、Reuters
- **每天自动更新**: 定时任务每天添加新文章
- **同事可以直接查看**: 无需下载 Excel

## 部署到云端

### Streamlit Cloud 部署

1. **上传代码到 GitHub**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/your-username/us-china-picker.git
   git push -u origin main
   ```

2. **部署到 Streamlit Cloud**
   - 访问 https://streamlit.io/cloud
   - 用 GitHub 登录
   - 点击 "New app"
   - 选择仓库，Main file path 填 `app_with_sheets_db.py`
   - 点击 "Deploy"

3. **配置环境变量**（在 Streamlit Cloud Settings）
   - `GOOGLE_SHEETS_ID`: Google Sheets ID
   - 上传 `google_credentials.json` 到 Streamlit Secrets

## 注意事项

1. **Google Sheets 设置**: 需要创建 Google Service Account 并下载凭证文件
2. **自动去重**: Google Sheets 和 RSS 中的重复文章会自动去除
3. **数据位置**: 数据存储在 Google Sheets，不会因部署而丢失
4. **定期检查**: 建议定期检查定时任务是否正常运行

## 故障排查

**问题：无法上传到 Google Sheets？**
- 检查 `google_credentials.json` 文件是否存在
- 检查 Google Sheets ID 是否正确
- 确认 Service Account 有 Editor 权限

**问题：定时任务没有运行？**
- 检查 cron 日志：`tail -f daily_collect.log`
- 手动运行测试：`python daily_collector_to_sheets.py`

**问题：网站无法读取 Google Sheets？**
- 检查 Streamlit Cloud 的环境变量配置
- 确认 Google Sheets ID 正确
- 检查 Google Sheets 权限设置

## 总结

✅ **定时任务每天自动抓取并上传到 Google Sheets**

✅ **网站自动从 Google Sheets 读取历史数据 + RSS 实时抓取**

✅ **数据在云端，不会丢失，同事可以直接查看**
