# API 预算跟踪机制说明

## 预算跟踪存储位置

预算跟踪数据存储在本地文件中：
- **文件路径**：`~/.us_china_picker/api_usage.json`
- **格式**：JSON 文件，按日期记录 API 调用次数

## 重启后的行为

### 本地环境（你的电脑）

**不会归零** ✅

- 文件存储在用户主目录（`~/.us_china_picker/api_usage.json`）
- 重启 Streamlit 应用**不会**删除这个文件
- 预算跟踪会**继续累计**，直到：
  - 日期改变（新的一天）
  - 手动删除文件
  - 文件系统被清理

**示例**：
```
重启前：今天已用 $0.05
重启后：今天已用 $0.05（保持不变）
```

### Streamlit Cloud（云端）

**会归零** ⚠️

- 文件存储在**临时文件系统**中
- 每次重启/重新部署应用时，临时文件系统会**清空**
- 预算跟踪会**重置为 0**

**示例**：
```
重启前：今天已用 $0.05
重启后：今天已用 $0.00（重置）
```

## 为什么 Streamlit Cloud 会归零？

Streamlit Cloud 使用**临时文件系统**（ephemeral file system）：
- 每次应用重启/重新部署时，所有临时文件都会被清除
- 这是 Streamlit Cloud 的设计，不是 bug
- 目的是确保每次部署都是"干净"的环境

## 实际影响

### 对预算控制的影响

| 环境 | 预算跟踪 | 预算控制有效性 |
|------|---------|--------------|
| **本地** | ✅ 持久化 | ✅ 完全有效 |
| **Streamlit Cloud** | ⚠️ 临时（重启重置） | ⚠️ 部分有效 |

### Streamlit Cloud 上的预算控制

虽然预算跟踪会重置，但**预算控制仍然有效**：

1. **UI 层面的保护**（处理前检查）
   - 在开始处理前就检查预算
   - 这个检查**不依赖**历史跟踪数据
   - 每次都是基于**当前会话**的估算

2. **API 调用层面的保护**（每次调用前检查）
   - 每次 API 调用前都检查预算
   - 使用**当前会话**的调用次数
   - 重启后从 0 开始计数

## 如何查看实际费用？

### Streamlit Cloud

由于预算跟踪会重置，建议：

1. **查看 OpenAI 门户**
   - 登录 https://platform.openai.com/
   - 查看 "Usage" 页面
   - 这里显示**真实的 API 使用量**和费用

2. **定期检查**
   - 每天或每周检查一次
   - 确认费用在预期范围内

### 本地环境

可以直接查看文件：
```bash
cat ~/.us_china_picker/api_usage.json
```

输出示例：
```json
{
  "2025-11-17": 50,
  "2025-11-18": 30
}
```
数字表示当天的 API 调用次数。

## 总结

| 问题 | 本地环境 | Streamlit Cloud |
|------|---------|----------------|
| **重启后预算归零？** | ❌ 不会 | ✅ 会 |
| **预算控制有效？** | ✅ 完全有效 | ⚠️ 部分有效（检查有效，但跟踪不准确） |
| **如何查看真实费用？** | 查看 `api_usage.json` | 查看 OpenAI 门户 |

## 建议

### 对于 Streamlit Cloud

1. **依赖 UI 层面的预算检查**（最可靠）
2. **定期查看 OpenAI 门户**的实际费用
3. **设置合理的每日预算**（例如 $0.05/天）
4. **不要完全依赖预算跟踪**（因为会重置）

### 对于本地环境

1. **预算跟踪完全有效**
2. **可以查看 `api_usage.json`** 了解详细使用情况
3. **每天自动重置**（新的一天）

## 常见问题

### Q: 为什么 Streamlit Cloud 的预算跟踪不准确？
A: 因为 Streamlit Cloud 使用临时文件系统，每次重启都会清空。这是平台的设计，不是 bug。

### Q: 重启后预算归零，会不会导致超支？
A: 不会。虽然跟踪会重置，但**预算检查机制仍然有效**：
- UI 层面会在处理前检查
- API 层面会在每次调用前检查
- 只是跟踪数据不准确，但控制仍然有效

### Q: 如何确保不会超支？
A: 
1. 设置合理的每日预算（例如 $0.05/天）
2. 定期查看 OpenAI 门户的实际费用
3. 依赖 UI 层面的预算检查（最可靠）

