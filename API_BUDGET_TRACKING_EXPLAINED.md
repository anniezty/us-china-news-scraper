# API 预算跟踪机制说明

## 重启后的行为

### Streamlit Cloud（云端）

**是的，重启后预算跟踪会归零。**

原因：
- 预算跟踪文件存储在临时文件系统中（`Path.home() / ".us_china_picker" / "api_usage.json"`）
- Streamlit Cloud 使用临时文件系统，每次重启/重新部署后会被清除
- 所以预算跟踪会重置为 0

**这意味着：**
- 重启后，`cost_today` 会显示为 `$0.000`
- 每日预算会重新开始计算
- 之前的调用记录会丢失

### 本地环境

**不会归零，会持续跟踪。**

原因：
- 预算跟踪文件存储在本地文件系统中（`~/.us_china_picker/api_usage.json`）
- 文件是持久化的，不会因为重启而丢失
- 每日预算会按日期（`YYYY-MM-DD`）分别跟踪

**这意味着：**
- 重启后，`cost_today` 会保持之前的记录
- 每日预算会按日期累计
- 每天自动重置（基于日期）

## 预算跟踪机制

### 存储位置

```python
USAGE_TRACK_PATH = Path.home() / ".us_china_picker" / "api_usage.json"
```

- **本地**：`~/.us_china_picker/api_usage.json`（持久化）
- **Streamlit Cloud**：临时文件系统（重启后清除）

### 数据结构

```json
{
  "2025-11-17": 100,  // 11/17 调用了 100 次
  "2025-11-18": 50    // 11/18 调用了 50 次
}
```

### 计算方式

```python
today = date.today().isoformat()  # "2025-11-18"
calls = usage.get(today, 0)       # 获取今天的调用次数
current_cost = calls * cost_per_call  # 计算今天的成本
```

## 实际影响

### Streamlit Cloud 的限制

由于预算跟踪会重置，**Streamlit Cloud 上的预算跟踪不准确**：

1. **重启后归零**：每次重启，之前的记录都会丢失
2. **无法跨重启跟踪**：如果一天内多次重启，无法累计当天的总使用量
3. **实际费用可能更高**：OpenAI 门户显示的实际费用可能比应用内显示的高

### 建议

1. **主要依赖 UI 层面的检查**（处理前检查）
   - 这是最可靠的保护
   - 在开始处理前就阻止超出预算的操作

2. **定期检查 OpenAI 门户**
   - Streamlit Cloud 的预算跟踪不准确
   - 定期检查 OpenAI 门户的实际费用

3. **设置合理的每日预算**
   - 基于实际使用量设置
   - 例如：$0.05/天（约 166 篇文章）

## 本地 vs. Streamlit Cloud 对比

| 特性 | 本地环境 | Streamlit Cloud |
|------|---------|----------------|
| **预算跟踪** | ✅ 持久化 | ⚠️ 临时（重启后清除） |
| **跨重启跟踪** | ✅ 支持 | ❌ 不支持 |
| **每日重置** | ✅ 按日期自动重置 | ⚠️ 重启后重置 |
| **准确性** | ✅ 准确 | ⚠️ 不准确（重启后归零） |

## 总结

- **Streamlit Cloud**：重启后预算跟踪会归零，这是临时文件系统的限制
- **本地环境**：预算跟踪是持久化的，不会因为重启而丢失
- **建议**：在 Streamlit Cloud 上，主要依赖 UI 层面的预算检查，并定期查看 OpenAI 门户的实际费用

