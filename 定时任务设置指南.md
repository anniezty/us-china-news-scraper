# å®šæ—¶ä»»åŠ¡è®¾ç½®æŒ‡å—

## ğŸ¯ ç›®æ ‡

æ¯å¤©è‡ªåŠ¨æŠ“å– NYTã€SCMPã€Reuters çš„æ–‡ç« å¹¶ä¸Šä¼ åˆ° Google Sheetsã€‚

## ğŸ“‹ è®¾ç½®æ­¥éª¤

### æ–¹å¼ 1: ä½¿ç”¨ Cronï¼ˆæ¨èï¼Œé€‚ç”¨äº Mac/Linuxï¼‰

#### æ­¥éª¤ 1: å‡†å¤‡è„šæœ¬

è„šæœ¬æ–‡ä»¶ï¼š`daily_collector_to_sheets.py`ï¼ˆå·²å­˜åœ¨ï¼‰

#### æ­¥éª¤ 2: è®¾ç½®ç¯å¢ƒå˜é‡

åœ¨ `~/.zshrc` æˆ– `~/.bash_profile` ä¸­æ·»åŠ ï¼š

```bash
# Google Sheets é…ç½®
export GOOGLE_SHEETS_ID="1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA"
export GOOGLE_CREDENTIALS_PATH="/Users/tingyuzheng/Downloads/us_china_picker/google_credentials.json"
```

æˆ–è€…ä½¿ç”¨ JSON å­—ç¬¦ä¸²ï¼ˆæ¨èï¼Œæ›´å®‰å…¨ï¼‰ï¼š

```bash
# å°† JSON æ–‡ä»¶å†…å®¹è½¬æ¢ä¸ºä¸€è¡Œï¼ˆå»é™¤æ¢è¡Œï¼‰
export GOOGLE_CREDENTIALS_JSON='{"type":"service_account","project_id":"...","private_key":"...","client_email":"..."}'
```

**å¦‚ä½•è·å– JSON å­—ç¬¦ä¸²**ï¼š
```bash
# æ–¹æ³• 1: ä½¿ç”¨ Python
python3 -c "import json; print(json.dumps(json.load(open('google_credentials.json')), separators=(',', ':')))"

# æ–¹æ³• 2: ä½¿ç”¨ jqï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
cat google_credentials.json | jq -c
```

#### æ­¥éª¤ 3: é‡æ–°åŠ è½½é…ç½®

```bash
source ~/.zshrc
```

#### æ­¥éª¤ 4: æµ‹è¯•è„šæœ¬

```bash
cd /Users/tingyuzheng/Downloads/us_china_picker
python3 daily_collector_to_sheets.py
```

åº”è¯¥çœ‹åˆ°ï¼š
```
[2024-XX-XX XX:XX:XX] å¼€å§‹æŠ“å– 2024-XX-XX çš„æ–‡ç« ...
[2024-XX-XX XX:XX:XX] æ‰¾åˆ° X ç¯‡æ–‡ç« 
[2024-XX-XX XX:XX:XX] âœ… æˆåŠŸä¸Šä¼  X ç¯‡æ–‡ç« åˆ° Google Sheets
```

#### æ­¥éª¤ 5: è®¾ç½® Cron ä»»åŠ¡

```bash
# ç¼–è¾‘ crontab
crontab -e
```

**æ·»åŠ ä»¥ä¸‹è¡Œ**ï¼ˆæ¯å¤©ä¸Šåˆ 9:00 æ‰§è¡Œï¼‰ï¼š

```cron
0 9 * * * cd /Users/tingyuzheng/Downloads/us_china_picker && /usr/bin/python3 daily_collector_to_sheets.py >> /Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.log 2>&1
```

**æˆ–è€…æ¯å¤©å‡Œæ™¨ 2:00**ï¼š

```cron
0 2 * * * cd /Users/tingyuzheng/Downloads/us_china_picker && /usr/bin/python3 daily_collector_to_sheets.py >> /Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.log 2>&1
```

**åˆ›å»ºæ—¥å¿—ç›®å½•**ï¼š

```bash
mkdir -p /Users/tingyuzheng/Downloads/us_china_picker/logs
```

#### æ­¥éª¤ 6: éªŒè¯ Cron ä»»åŠ¡

```bash
# æŸ¥çœ‹å½“å‰ cron ä»»åŠ¡
crontab -l

# æŸ¥çœ‹æ—¥å¿—ï¼ˆæ‰§è¡Œåï¼‰
tail -f /Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.log
```

---

### æ–¹å¼ 2: ä½¿ç”¨ LaunchAgentï¼ˆMacï¼Œæ¨èç”¨äºä¸ªäººç”µè„‘ï¼‰

#### æ­¥éª¤ 1: åˆ›å»º plist æ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ï¼š`~/Library/LaunchAgents/com.uschina.dailycollector.plist`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.uschina.dailycollector</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/python3</string>
        <string>/Users/tingyuzheng/Downloads/us_china_picker/daily_collector_to_sheets.py</string>
    </array>
    <key>WorkingDirectory</key>
    <string>/Users/tingyuzheng/Downloads/us_china_picker</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>GOOGLE_SHEETS_ID</key>
        <string>1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA</string>
        <key>GOOGLE_CREDENTIALS_PATH</key>
        <string>/Users/tingyuzheng/Downloads/us_china_picker/google_credentials.json</string>
    </dict>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>9</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
    <key>StandardOutPath</key>
    <string>/Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.error.log</string>
</dict>
</plist>
```

#### æ­¥éª¤ 2: åŠ è½½ä»»åŠ¡

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /Users/tingyuzheng/Downloads/us_china_picker/logs

# åŠ è½½ä»»åŠ¡
launchctl load ~/Library/LaunchAgents/com.uschina.dailycollector.plist

# ç«‹å³æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
launchctl start com.uschina.dailycollector
```

#### æ­¥éª¤ 3: ç®¡ç†ä»»åŠ¡

```bash
# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
launchctl list | grep uschina

# åœæ­¢ä»»åŠ¡
launchctl unload ~/Library/LaunchAgents/com.uschina.dailycollector.plist

# é‡æ–°åŠ è½½ï¼ˆä¿®æ”¹é…ç½®åï¼‰
launchctl unload ~/Library/LaunchAgents/com.uschina.dailycollector.plist
launchctl load ~/Library/LaunchAgents/com.uschina.dailycollector.plist
```

---

### æ–¹å¼ 3: ä½¿ç”¨ Streamlit Cloud Scheduled Functionsï¼ˆå®éªŒæ€§ï¼‰

å¦‚æœéƒ¨ç½²åœ¨ Streamlit Cloudï¼Œå¯ä»¥ä½¿ç”¨ Streamlit çš„å®šæ—¶åŠŸèƒ½ï¼ˆéœ€è¦ Streamlit Cloud ä¼ä¸šç‰ˆæˆ–ç­‰å¾…åŠŸèƒ½å¼€æ”¾ï¼‰ã€‚

---

## ğŸ”§ é…ç½® Streamlit Cloud Secrets

åœ¨ Streamlit Cloud ä¸­é…ç½®å‡­è¯ï¼ˆç”¨äºç½‘ç«™è¯»å–ï¼‰ï¼š

### æ­¥éª¤ 1: æ‰“å¼€ Secrets

Streamlit Cloud â†’ ä½ çš„åº”ç”¨ â†’ Settings â†’ Secrets

### æ­¥éª¤ 2: æ·»åŠ é…ç½®

```toml
GOOGLE_SHEETS_ID = "1Cltg8pq-jhtgR6_lysW-gNIe9JSKOh2vCT4Pxo7pcpA"

[google_sheets]
credentials = '''
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "xxxxx",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "us-china-picker-sa@your-project.iam.gserviceaccount.com",
  "client_id": "xxxxx",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/..."
}
'''
```

**å¦‚ä½•è·å– JSON å†…å®¹**ï¼š
1. æ‰“å¼€ä¸‹è½½çš„ `google_credentials.json` æ–‡ä»¶
2. å¤åˆ¶å…¨éƒ¨å†…å®¹
3. ç²˜è´´åˆ° `credentials = '''...'''` ä¸­

---

## âœ… éªŒè¯

### æµ‹è¯•æœ¬åœ°è„šæœ¬

```bash
cd /Users/tingyuzheng/Downloads/us_china_picker
python3 daily_collector_to_sheets.py
```

### æ£€æŸ¥ Google Sheets

æ‰“å¼€ä½ çš„ Google Sheetsï¼Œåº”è¯¥çœ‹åˆ°æ–°çš„ sheet æˆ–æ•°æ®æ›´æ–°ã€‚

### æŸ¥çœ‹æ—¥å¿—

```bash
tail -f /Users/tingyuzheng/Downloads/us_china_picker/logs/daily_collector.log
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. "Google å‡­è¯æ–‡ä»¶ä¸å­˜åœ¨"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ `google_credentials.json` æ–‡ä»¶å­˜åœ¨
- æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ `GOOGLE_CREDENTIALS_JSON`
- æˆ–åœ¨ Streamlit Secrets ä¸­é…ç½®

### 2. "Permission denied"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ Google Sheets å·²åˆ†äº«ç»™ Service Account é‚®ç®±
- æƒé™è®¾ç½®ä¸º "Editor"

### 3. Cron ä»»åŠ¡ä¸æ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ cron æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`sudo launchctl list | grep cron`
- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æƒé™
- ä½¿ç”¨ç»å¯¹è·¯å¾„è€Œéç›¸å¯¹è·¯å¾„
- æ£€æŸ¥ Python è·¯å¾„ï¼š`which python3`

### 4. ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ cron ä¸­ç›´æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```cron
0 9 * * * export GOOGLE_SHEETS_ID="..." && export GOOGLE_CREDENTIALS_PATH="..." && cd /path/to/project && python3 daily_collector_to_sheets.py
```

---

## ğŸ“ æ¨èé…ç½®

**ä¸ªäººç”µè„‘ï¼ˆMacï¼‰**ï¼šä½¿ç”¨ LaunchAgentï¼ˆæ–¹å¼ 2ï¼‰
- æ›´æ˜“ç®¡ç†
- å¼€æœºè‡ªåŠ¨å¯åŠ¨
- æ›´å¥½çš„æ—¥å¿—ç®¡ç†

**æœåŠ¡å™¨/æŒç»­è¿è¡Œ**ï¼šä½¿ç”¨ Cronï¼ˆæ–¹å¼ 1ï¼‰
- æ›´è½»é‡
- æ›´ç¨³å®š
- æ›´é€šç”¨

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è®¾ç½®å®Œæˆåï¼š
1. âœ… æ¯å¤©è‡ªåŠ¨æŠ“å–æ•°æ®åˆ° Google Sheets
2. âœ… ç½‘ç«™å¯ä»¥ä» Google Sheets è¯»å–å†å²æ•°æ®
3. âœ… åŒäº‹å¯ä»¥éšæ—¶ä¸‹è½½æœ€æ–°æ•°æ®

